/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","jquery","app/core/utils/file_export","app/plugins/sdk","./transformers","./editor","./renderer"],function(a){var b,c,d,e,f,g,h,i,j,k=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){b=a},function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a},function(a){g=a},function(a){h=a}],execute:function(){i={targets:[{}],transform:"timeseries_to_columns",pageSize:null,showHeader:!0,styles:[{type:"date",pattern:"Time",dateFormat:"YYYY-MM-DD HH:mm:ss"},{unit:"short",type:"number",decimals:2,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],colorMode:null,pattern:"/.*/",thresholds:[]}],columns:[],scroll:!0,fontSize:"100%",sort:{col:0,desc:!0}},j=function(a){function e(c,d,e){a.call(this,c,d),this.annotationsSrv=e,this.pageIndex=0,void 0===this.panel.styles&&(this.panel.styles=this.panel.columns,this.panel.columns=this.panel.fields,delete this.panel.columns,delete this.panel.fields),b["default"].defaults(this.panel,i)}return k(e,a),e.$inject=["$scope","$injector","annotationsSrv"],e.prototype.initEditMode=function(){a.prototype.initEditMode.call(this),this.addEditorTab("Options",g.tablePanelEditor,2)},e.prototype.getExtendedMenu=function(){var b=a.prototype.getExtendedMenu.call(this);return b.push({text:"Export CSV",click:"ctrl.exportCsv()"}),b},e.prototype.refreshData=function(a){var b=this;return this.pageIndex=0,"annotations"===this.panel.transform?this.annotationsSrv.getAnnotations(this.dashboard).then(function(a){b.dataRaw=a,b.render()}):this.issueQueries(a).then(this.dataHandler.bind(this))["catch"](function(a){throw b.render(),a})},e.prototype.toggleColumnSort=function(a,b){this.panel.sort.col===b?this.panel.sort.desc?this.panel.sort.desc=!1:this.panel.sort.col=null:(this.panel.sort.col=b,this.panel.sort.desc=!0),this.render()},e.prototype.dataHandler=function(a){this.dataRaw=a.data,this.pageIndex=0,this.render()},e.prototype.render=function(){this.dataRaw&&this.dataRaw.length&&("table"===this.dataRaw[0].type?this.panel.transform="table":"docs"===this.dataRaw[0].type?this.panel.transform="json":("table"===this.panel.transform||"json"===this.panel.transform)&&(this.panel.transform="timeseries_to_rows")),this.table=f.transformDataToTable(this.dataRaw,this.panel),this.table.sort(this.panel.sort),this.broadcastRender(this.table)},e.prototype.exportCsv=function(){d.exportTableDataToCsv(this.table)},e.prototype.link=function(a,d,e,f){function g(){var a=f.height||f.panel.height||f.row.height;return b["default"].isString(a)&&(a=parseInt(a.replace("px",""),10)),o>1&&(a-=28),a-60+"px"}function i(a){var b=new h.TableRenderer(n,m,f.dashboard.timezone);a.empty(),a.html(b.render(f.pageIndex))}function j(a){var b=c["default"](a.currentTarget);f.pageIndex=parseInt(b.text(),10)-1,l()}function k(a){a.empty();var b=n.pageSize||100;if(o=Math.ceil(m.rows.length/b),1!==o){for(var d=Math.max(f.pageIndex-3,0),e=Math.min(o,d+9),g=c["default"]("<ul></ul>"),h=d;e>h;h++){var i=h===f.pageIndex?"active":"",j=c["default"]('<li><a class="table-panel-page-link pointer '+i+'">'+(h+1)+"</a></li>");g.append(j)}a.append(g)}}function l(){var a=d.parents(".panel"),b=d.find(".table-panel-scroll"),c=d.find("tbody"),e=d.find(".table-panel-footer");d.css({"font-size":n.fontSize}),a.addClass("table-panel-wrapper"),i(c),k(e),b.css({"max-height":n.scroll?g():""})}var m,n=f.panel,o=0;d.on("click",".table-panel-page-link",j),a.$on("$destroy",function(){d.off("click",".table-panel-page-link")}),a.$on("render",function(a,b){m=b||m,m&&l()})},e.templateUrl="module.html",e}(e.MetricsPanelCtrl),a("TablePanelCtrl",j),a("PanelCtrl",j)}}});