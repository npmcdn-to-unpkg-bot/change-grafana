/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["./graph","./legend","./seriesOverridesCtrl","moment","app/core/utils/kbn","lodash","app/core/time_series2","app/core/utils/file_export","app/plugins/sdk"],function(a){var b,c,d,e,f,g,h,i,j=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){},function(a){},function(a){},function(a){b=a},function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a},function(a){g=a}],execute:function(){h={datasource:null,renderer:"flot","x-axis":!0,"y-axis":!0,y_formats:["short","short"],grid:{leftLogBase:1,leftMax:null,rightMax:null,leftMin:null,rightMin:null,rightLogBase:1,threshold1:null,threshold2:null,threshold1Color:"rgba(216, 200, 27, 0.27)",threshold2Color:"rgba(234, 112, 112, 0.22)"},lines:!0,fill:1,linewidth:2,points:!1,pointradius:5,bars:!1,stack:!1,percentage:!1,legend:{show:!0,values:!1,min:!1,max:!1,current:!1,total:!1,avg:!1},nullPointMode:"connected",steppedLine:!1,tooltip:{value_type:"cumulative",shared:!0},timeFrom:null,timeShift:null,targets:[{}],aliasColors:{},seriesOverrides:[]},i=function(a){function g(b,c,e){a.call(this,b,c),this.annotationsSrv=e,this.hiddenSeries={},this.seriesList=[],this.colors=[],d["default"].defaults(this.panel,h),d["default"].defaults(this.panel.tooltip,h.tooltip),d["default"].defaults(this.panel.grid,h.grid),d["default"].defaults(this.panel.legend,h.legend),this.colors=b.$root.colors}return j(g,a),g.$inject=["$scope","$injector","annotationsSrv"],g.prototype.initEditMode=function(){a.prototype.initEditMode.call(this),this.icon="fa fa-bar-chart",this.addEditorTab("Axes & Grid","public/app/plugins/panel/graph/axisEditor.html",2),this.addEditorTab("Display Styles","public/app/plugins/panel/graph/styleEditor.html",3),this.logScales={linear:1,"log (base 2)":2,"log (base 10)":10,"log (base 32)":32,"log (base 1024)":1024},this.unitFormats=c["default"].getUnitFormats()},g.prototype.getExtendedMenu=function(){var b=a.prototype.getExtendedMenu.call(this);return b.push({text:"Export CSV",click:"ctrl.exportCsv()"}),b.push({text:"Toggle legend",click:"ctrl.toggleLegend()"}),b},g.prototype.setUnitFormat=function(a,b){this.panel.y_formats[a]=b.value,this.render()},g.prototype.refreshData=function(a){var b=this;return this.annotationsPromise=this.annotationsSrv.getAnnotations(this.dashboard),this.issueQueries(a).then(function(a){return b.dataHandler(a)})["catch"](function(a){throw b.seriesList=[],b.render([]),a})},g.prototype.zoomOut=function(a){this.publishAppEvent("zoom-out",a)},g.prototype.loadSnapshot=function(a){this.annotationsPromise=this.annotationsSrv.getAnnotations(this.dashboard),this.dataHandler(a)},g.prototype.dataHandler=function(a){var b=this;return d["default"].isString(a)?void this.render(a):(this.datapointsWarning=!1,this.datapointsCount=0,this.datapointsOutside=!1,this.seriesList=d["default"].map(a.data,function(a,c){return b.seriesHandler(a,c)}),this.datapointsWarning=0===this.datapointsCount||this.datapointsOutside,void this.annotationsPromise.then(function(a){b.loading=!1,b.seriesList.annotations=a,b.render(b.seriesList)},function(){b.loading=!1,b.render(b.seriesList)}))},g.prototype.seriesHandler=function(a,c){var d=a.datapoints,f=a.target,g=c%this.colors.length,h=this.panel.aliasColors[f]||this.colors[g],i=new e["default"]({datapoints:d,alias:f,color:h});if(d&&d.length>0){var j=b["default"].utc(d[d.length-1][1]),k=b["default"].utc(this.range.from);-1e4>j-k&&(this.datapointsOutside=!0),this.datapointsCount+=d.length}return i},g.prototype.render=function(a){this.broadcastRender(a)},g.prototype.changeSeriesColor=function(a,b){a.color=b,this.panel.aliasColors[a.alias]=a.color,this.render()},g.prototype.toggleSeries=function(a,b){b.ctrlKey||b.metaKey||b.shiftKey?this.hiddenSeries[a.alias]?delete this.hiddenSeries[a.alias]:this.hiddenSeries[a.alias]=!0:this.toggleSeriesExclusiveMode(a),this.render()},g.prototype.toggleSeriesExclusiveMode=function(a){var b=this,c=this.hiddenSeries;c[a.alias]&&delete c[a.alias];var e=d["default"].every(this.seriesList,function(b){return b.alias===a.alias?!0:c[b.alias]});e?d["default"].each(this.seriesList,function(a){delete b.hiddenSeries[a.alias]}):d["default"].each(this.seriesList,function(c){c.alias!==a.alias&&(b.hiddenSeries[c.alias]=!0)})},g.prototype.toggleYAxis=function(a){var b=d["default"].findWhere(this.panel.seriesOverrides,{alias:a.alias});b||(b={alias:a.alias},this.panel.seriesOverrides.push(b)),b.yaxis=2===a.yaxis?1:2,this.render()},g.prototype.addSeriesOverride=function(a){this.panel.seriesOverrides.push(a||{})},g.prototype.removeSeriesOverride=function(a){this.panel.seriesOverrides=d["default"].without(this.panel.seriesOverrides,a),this.render()},g.prototype.toggleLegend=function(){this.panel.legend.show=!this.panel.legend.show,this.refresh()},g.prototype.legendValuesOptionChanged=function(){var a=this.panel.legend;a.values=a.min||a.max||a.avg||a.current||a.total,this.render()},g.prototype.exportCsv=function(){f.exportSeriesListToCsv(this.seriesList)},g.templateUrl="module.html",g}(g.MetricsPanelCtrl),a("GraphCtrl",i),a("PanelCtrl",i)}}});