/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","jquery","jquery.flot","jquery.flot.time"],function(a,b,c){"use strict";var d=a.module("grafana.directives");d.directive("graphLegend",["popoverSrv",function(a){return{link:function(d,e){function f(a){return a.parents("[data-series-index]").data("series-index")}function g(b){if(!c(b.target).parents(".popover").length){var e=c(b.currentTarget).find(".fa-minus"),g=f(e),h=m[g],i=d.$new();i.series=h,a.show({element:e,templateUrl:"public/app/plugins/panel/graph/legend.popover.html",scope:i})}}function h(a){var b=c(a.currentTarget),d=f(b),e=m[d];q.toggleSeries(e,a)}function i(a){var b=c(a.currentTarget),d=b.data("stat");return d!==r.legend.sort&&(r.legend.sortDesc=null),r.legend.sortDesc===!1?(r.legend.sort=null,r.legend.sortDesc=null,void k()):(r.legend.sortDesc=!r.legend.sortDesc,r.legend.sort=d,void k())}function j(a){if(!r.legend[a])return"";var b='<th class="pointer" data-stat="'+a+'">'+a;if(r.legend.sort===a){var c=r.legend.sortDesc?"fa fa-caret-down":"fa fa-caret-up";b+=' <span class="'+c+'"></span>'}return b+"</th>"}function k(){p&&(e.append(o),o.on("click",".graph-legend-icon",g),o.on("click",".graph-legend-alias",h),o.on("click","th",i),p=!1),m=l,o.empty();var a=r.legend.rightSide&&r.legend.sideWidth?r.legend.sideWidth+"px":"";if(o.css("min-width",a),o.toggleClass("graph-legend-table",r.legend.alignAsTable===!0),r.legend.alignAsTable){var f="<tr>";f+='<th colspan="2" style="text-align:left"></th>',r.legend.values&&(f+=j("min"),f+=j("max"),f+=j("avg"),f+=j("current"),f+=j("total")),f+="</tr>",o.append(c(f))}for(r.legend.sort&&(m=b.sortBy(m,function(a){return a.stats[r.legend.sort]}),r.legend.sortDesc&&(m=m.reverse())),n=0;n<m.length;n++){var k=m[n];if((!r.legend.hideEmpty||!k.allIsNull)&&k.legend&&(!r.legend.hideZero||!k.allIsZero)){var s='<div class="graph-legend-series';if(2===k.yaxis&&(s+=" pull-right"),q.hiddenSeries[k.alias]&&(s+=" graph-legend-series-hidden"),s+='" data-series-index="'+n+'">',s+='<div class="graph-legend-icon">',s+='<i class="fa fa-minus pointer" style="color:'+k.color+'"></i>',s+="</div>",s+='<div class="graph-legend-alias">',s+="<a>"+b.escape(k.label)+"</a>",s+="</div>",r.legend.values){var t=k.formatValue(k.stats.avg),u=k.formatValue(k.stats.current),v=k.formatValue(k.stats.min),w=k.formatValue(k.stats.max),x=k.formatValue(k.stats.total);r.legend.min&&(s+='<div class="graph-legend-value min">'+v+"</div>"),r.legend.max&&(s+='<div class="graph-legend-value max">'+w+"</div>"),r.legend.avg&&(s+='<div class="graph-legend-value avg">'+t+"</div>"),r.legend.current&&(s+='<div class="graph-legend-value current">'+u+"</div>"),r.legend.total&&(s+='<div class="graph-legend-value total">'+x+"</div>")}s+="</div>",o.append(c(s))}}var y=o.parent().height(),z=o.height();r.legend.rightSide&&z>=y&&o.toggleClass("graph-legend-fixed-height",!0),r.legend.rightSide?o.css("height",d.ctrl.height||d.ctrl.panel.height||d.ctrl.row.height):o.css("height","")}var l,m,n,o=c('<section class="graph-legend"></section>'),p=!0,q=d.ctrl,r=q.panel;d.$on("render",function(){l=q.seriesList,l&&k()})}}}])});