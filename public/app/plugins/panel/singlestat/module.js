/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","jquery","jquery.flot","app/core/utils/kbn","app/core/time_series2","app/plugins/sdk"],function(a){function b(a,b){for(var d=a.thresholds.length;d>0;d--)if(b>=a.thresholds[d-1])return a.colorMap[d];return c["default"].first(a.colorMap)}var c,d,e,f,g,h,i,j=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};return{setters:[function(a){c=a},function(a){d=a},function(a){},function(a){e=a},function(a){f=a},function(a){g=a}],execute:function(){h={links:[],datasource:null,maxDataPoints:100,interval:null,targets:[{}],cacheTimeout:null,format:"none",prefix:"",postfix:"",nullText:null,valueMaps:[{value:"null",op:"=",text:"N/A"}],nullPointMode:"connected",valueName:"avg",prefixFontSize:"50%",valueFontSize:"80%",postfixFontSize:"50%",thresholds:"",colorBackground:!1,colorValue:!1,colors:["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],sparkline:{show:!1,full:!1,lineColor:"rgb(31, 120, 193)",fillColor:"rgba(31, 118, 189, 0.18)"}},i=function(a){function g(b,d,e,f,g){a.call(this,b,d),this.$location=e,this.linkSrv=f,this.templateSrv=g,c["default"].defaults(this.panel,h)}return j(g,a),g.$inject=["$scope","$injector","$location","linkSrv","templateSrv"],g.prototype.initEditMode=function(){a.prototype.initEditMode.call(this),this.icon="fa fa-dashboard",this.fontSizes=["20%","30%","50%","70%","80%","100%","110%","120%","150%","170%","200%"],this.addEditorTab("Options","public/app/plugins/panel/singlestat/editor.html",2),this.unitFormats=e["default"].getUnitFormats()},g.prototype.setUnitFormat=function(a){this.panel.format=a.value,this.render()},g.prototype.refreshData=function(a){var b=this;return this.issueQueries(a).then(this.dataHandler.bind(this))["catch"](function(a){throw b.series=[],b.render(),a})},g.prototype.loadSnapshot=function(a){var b=this;this.$timeout(function(){return b.dataHandler(a)},50)},g.prototype.dataHandler=function(a){this.series=c["default"].map(a.data,this.seriesHandler.bind(this)),this.render()},g.prototype.seriesHandler=function(a){var b=new f["default"]({datapoints:a.datapoints,alias:a.target});return b.flotpairs=b.getFlotPairs(this.panel.nullPointMode),b},g.prototype.setColoring=function(a){a.background?(this.panel.colorValue=!1,this.panel.colors=["rgba(71, 212, 59, 0.4)","rgba(245, 150, 40, 0.73)","rgba(225, 40, 40, 0.59)"]):(this.panel.colorBackground=!1,this.panel.colors=["rgba(50, 172, 45, 0.97)","rgba(237, 129, 40, 0.89)","rgba(245, 54, 54, 0.9)"]),this.render()},g.prototype.invertColorOrder=function(){var a=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=a,this.render()},g.prototype.getDecimalsForValue=function(a){if(c["default"].isNumber(this.panel.decimals))return{decimals:this.panel.decimals,scaledDecimals:null};var b,d=a/2,e=-Math.floor(Math.log(d)/Math.LN10),f=Math.pow(10,-e),g=d/f;1.5>g?b=1:3>g?(b=2,g>2.25&&(b=2.5,++e)):b=7.5>g?5:10,b*=f,Math.floor(a)===a&&(e=0);var h={};return h.decimals=Math.max(0,e),h.scaledDecimals=h.decimals-Math.floor(Math.log(b)/Math.LN10)+2,h},g.prototype.render=function(){var a={};this.setValues(a),a.thresholds=this.panel.thresholds.split(",").map(function(a){return Number(a.trim())}),a.colorMap=this.panel.colors,this.data=a,this.broadcastRender()},g.prototype.setValues=function(a){if(a.flotpairs=[],this.series.length>1){var b=new Error;throw b.message="Multiple Series Error",b.data="Metric query returns "+this.series.length+" series. Single Stat Panel expects a single series.\n\nResponse:\n"+JSON.stringify(this.series),b}if(this.series&&this.series.length>0){var d=c["default"].last(this.series[0].datapoints),f=c["default"].isArray(d)?d[0]:null;if(c["default"].isString(f))a.value=0,a.valueFormated=f,a.valueRounded=0;else{a.value=this.series[0].stats[this.panel.valueName],a.flotpairs=this.series[0].flotpairs;var g=this.getDecimalsForValue(a.value),h=e["default"].valueFormats[this.panel.format];a.valueFormated=h(a.value,g.decimals,g.scaledDecimals),a.valueRounded=e["default"].roundValue(a.value,g.decimals)}}for(var i=0;i<this.panel.valueMaps.length;i++){var j=this.panel.valueMaps[i];if("null"!==j.value){var k=parseFloat(j.value);if(k===a.value)return void(a.valueFormated=j.text)}else if(null===a.value||void 0===a.value)return void(a.valueFormated=j.text)}(null===a.value||void 0===a.value)&&(a.valueFormated="no value")},g.prototype.removeValueMap=function(a){var b=c["default"].indexOf(this.panel.valueMaps,a);this.panel.valueMaps.splice(b,1),this.render()},g.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},g.prototype.link=function(a,e,f,g){function h(){try{return q=g.height||u.height||g.row.height,c["default"].isString(q)&&(q=parseInt(q.replace("px",""),10)),q-=5,q-=u.title?24:9,e.css("height",q+"px"),!0}catch(a){return!1}}function i(a,c){if(!u.colorValue)return c;var d=b(o,a);return d?'<span style="color:'+d+'">'+c+"</span>":c}function j(a,b,c){return c=v.replace(c),'<span class="'+a+'" style="font-size:'+b+'">'+c+"</span>"}function k(){var a='<div class="singlestat-panel-value-container">';u.prefix&&(a+=j("singlestat-panel-prefix",u.prefixFontSize,u.prefix));var b=i(o.valueRounded,o.valueFormated);return a+=j("singlestat-panel-value",u.valueFontSize,b),u.postfix&&(a+=j("singlestat-panel-postfix",u.postfixFontSize,u.postfix)),a+="</div>"}function l(){var a=e.width()+20,b=q,c=d["default"]("<div></div>"),f={};if(f.position="absolute",u.sparkline.full){f.bottom="5px",f.left="-5px",f.width=a-10+"px";var h=100>=b?5:15*Math.round(b/100)+5;f.height=b-h+"px"}else f.bottom="0px",f.left="-5px",f.width=a-10+"px",f.height=Math.floor(.25*b)+"px";c.css(f);var i={legend:{show:!1},series:{lines:{show:!0,fill:1,lineWidth:1,fillColor:u.sparkline.fillColor}},yaxes:{show:!1},xaxis:{show:!1,mode:"time",min:g.range.from.valueOf(),max:g.range.to.valueOf()},grid:{hoverable:!1,show:!1}};e.append(c);var j={data:o.flotpairs,color:u.sparkline.lineColor};d["default"].plot(c,[j],i)}function m(){if(g.data){o=g.data,h();var c=k();if(u.colorBackground&&!isNaN(o.valueRounded)){var d=b(o,o.valueRounded);d&&(w.css("background-color",d),a.fullscreen?e.css("background-color",d):e.css("background-color",""))}else w.css("background-color",""),e.css("background-color","");e.html(c),u.sparkline.show&&l(),e.toggleClass("pointer",u.links.length>0),p=u.links.length>0?s.getPanelLinkAnchorInfo(u.links[0],u.scopedVars):null}}function n(){var a=d["default"]('<div id="tooltip" class="">hello</div>"');e.mouseleave(function(){0!==u.links.length&&a.detach()}),e.click(function(b){if(p&&!(d["default"](b).parents(".panel-header").length>0)){if("_blank"===p.target){var c=window.open(p.href,"_blank");return void c.location}0===p.href.indexOf("http")?window.location.href=p.href:t(function(){r.url(p.href)}),a.detach()}}),e.mousemove(function(b){p&&(a.text("click to go to: "+p.title),a.place_tt(b.pageX+20,b.pageY-15))})}var o,p,q,r=this.$location,s=this.linkSrv,t=this.$timeout,u=g.panel,v=this.templateSrv,w=e.find(".panel-container");e=e.find(".singlestat-panel"),n(),a.$on("render",function(){m(),g.renderingCompleted()})},g.templateUrl="module.html",g}(g.MetricsPanelCtrl),a("SingleStatCtrl",i),a("PanelCtrl",i),a("getColorForValue",b)}}});