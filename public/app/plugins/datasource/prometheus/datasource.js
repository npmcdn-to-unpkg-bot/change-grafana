/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","moment","app/core/utils/datemath","./metric_find_query"],function(a){function b(a,b,h,i){function j(a,b){return c["default"].isString(a)&&(a=e.parse(a,b)),Math.ceil(a.valueOf()/1e3)}this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.name=a.name,this.supportMetrics=!0,this.url=a.url,this.directUrl=a.directUrl,this.basicAuth=a.basicAuth,this.withCredentials=a.withCredentials,this.lastErrors={},this._request=function(a,b){var c={url:this.url+b,method:a};return(this.basicAuth||this.withCredentials)&&(c.withCredentials=!0),this.basicAuth&&(c.headers={Authorization:this.basicAuth}),h.datasourceRequest(c)},this.query=function(a){var d=j(a.range.from,!1),e=j(a.range.to,!0),f=[];if(a=c["default"].clone(a),c["default"].each(a.targets,c["default"].bind(function(b){if(b.expr&&!b.hide){var c={};c.expr=i.replace(b.expr,a.scopedVars);var g=b.interval||a.interval,h=b.intervalFactor||1;b.step=c.step=this.calculateInterval(g,h);var j=Math.ceil(e-d);0!==c.step&&j/c.step>11e3&&(b.step=c.step=Math.ceil(j/11e3)),f.push(c)}},this)),c["default"].isEmpty(f)){var g=b.defer();return g.resolve({data:[]}),g.promise}var h=c["default"].map(f,c["default"].bind(function(a){return this.performTimeSeriesQuery(a,d,e)},this)),k=this;return b.all(h).then(function(b){var f=[];return c["default"].each(b,function(b,g){if("error"===b.status)throw k.lastErrors.query=b.error,b.error;delete k.lastErrors.query,c["default"].each(b.data.data.result,function(b){f.push(k.transformMetricData(b,a.targets[g],d,e))})}),{data:f}})},this.performTimeSeriesQuery=function(a,b,c){var d="/api/v1/query_range?query="+encodeURIComponent(a.expr)+"&start="+b+"&end="+c+"&step="+a.step;return this._request("GET",d)},this.performSuggestQuery=function(a){var b="/api/v1/label/__name__/values";return this._request("GET",b).then(function(b){return c["default"].filter(b.data.data,function(b){return 1!==b.indexOf(a)})})},this.metricFindQuery=function(a){if(!a)return b.when([]);var c;try{c=i.replace(a)}catch(d){return b.reject(d)}var e=new f["default"](this,c);return e.process()},this.annotationQuery=function(a){var d=a.annotation,e=d.expr||"",f=d.tagKeys||"",g=d.titleFormat||"",h=d.textFormat||"";if(!e)return b.when([]);var k;try{k=i.replace(e)}catch(l){return b.reject(l)}var m={expr:k,step:"60s"},n=j(a.range.from,!1),o=j(a.range.to,!0),p=this;return this.performTimeSeriesQuery(m,n,o).then(function(a){var b=[];return f=f.split(","),c["default"].each(a.data.data.result,function(a){var e=c["default"].chain(a.metric).filter(function(a,b){return c["default"].contains(f,b)}).value();c["default"].each(a.values,function(c){if("1"===c[1]){var f={annotation:d,time:1e3*Math.floor(c[0]),title:p.renderTemplate(g,a.metric),tags:e,text:p.renderTemplate(h,a.metric)};b.push(f)}})}),b})},this.testDatasource=function(){return this.metricFindQuery("metrics(.*)").then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},this.calculateInterval=function(a,b){var c=a.match(g),e=d["default"].duration(parseInt(c[1]),c[2]),f=e.asSeconds();return 1>f&&(f=1),Math.ceil(f*b)},this.transformMetricData=function(a,b,d,e){var f=[],g=null;g=this.createMetricLabel(a.metric,b);var h=1e3*parseInt(b.step),i=1e3*d;c["default"].each(a.values,function(a){var b=parseFloat(a[1]);c["default"].isNaN(b)&&(b=null);for(var d=1e3*a[0],e=i;d>e;e+=h)f.push([null,e]);i=d+h,f.push([b,d])});for(var j=1e3*e,k=i;j>=k;k+=h)f.push([null,k]);return{target:g,datapoints:f}},this.createMetricLabel=function(a,b){return c["default"].isUndefined(b)||c["default"].isEmpty(b.legendFormat)?this.getOriginalMetricName(a):this.renderTemplate(b.legendFormat,a)||"{}"},this.renderTemplate=function(a,b){var d=c["default"].templateSettings;c["default"].templateSettings={interpolate:/\{\{(.+?)\}\}/g};var e,f=c["default"].template(i.replace(a));try{e=f(b)}catch(g){e=null}return c["default"].templateSettings=d,e},this.getOriginalMetricName=function(a){var b=a.__name__||"";delete a.__name__;var d=c["default"].map(c["default"].pairs(a),function(a){return a[0]+'="'+a[1]+'"'}).join(",");return b+"{"+d+"}"}}b.$inject=["instanceSettings","$q","backendSrv","templateSrv"];var c,d,e,f,g;return a("PrometheusDatasource",b),{setters:[function(a){c=a},function(a){d=a},function(a){e=a},function(a){f=a}],execute:function(){g=/(\d+)(ms|s|m|h|d|w|M|y)/}}});