/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","./query_part"],function(a){var b,c,d;return{setters:[function(a){b=a},function(a){c=a}],execute:function(){d=function(){function a(a){this.target=a,a.policy=a.policy||"default",a.dsType="influxdb",a.resultFormat=a.resultFormat||"time_series",a.tags=a.tags||[],a.groupBy=a.groupBy||[{type:"time",params:["$interval"]},{type:"fill",params:["null"]}],a.select=a.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}return a.prototype.updateProjection=function(){this.selectModels=b["default"].map(this.target.select,function(a){return b["default"].map(a,c["default"].create)}),this.groupByParts=b["default"].map(this.target.groupBy,c["default"].create)},a.prototype.updatePersistedParts=function(){this.target.select=b["default"].map(this.selectModels,function(a){return b["default"].map(a,function(a){return{type:a.def.type,params:a.params}})})},a.prototype.hasGroupByTime=function(){return b["default"].find(this.target.groupBy,function(a){return"time"===a.type})},a.prototype.hasFill=function(){return b["default"].find(this.target.groupBy,function(a){return"fill"===a.type})},a.prototype.addGroupBy=function(a){var b=a.match(/^(\w+)\((.*)\)$/),d=b[1],e=b[2],f=c["default"].create({type:d,params:[e]}),g=this.target.groupBy.length;0===g?this.target.groupBy.push(f.part):"time"===d?this.target.groupBy.splice(0,0,f.part):"tag"===d&&"fill"===this.target.groupBy[g-1].type?this.target.groupBy.splice(g-1,0,f.part):this.target.groupBy.push(f.part),this.updateProjection()},a.prototype.removeGroupByPart=function(a,d){var e=c["default"].getCategories();"time"===a.def.type&&(this.target.groupBy=b["default"].filter(this.target.groupBy,function(a){return"fill"!==a.type}),this.target.select=b["default"].map(this.target.select,function(a){return b["default"].filter(a,function(a){var b=c["default"].create(a);return b.def.category===e.Aggregations?!1:b.def.category===e.Selectors?!1:!0})})),this.target.groupBy.splice(d,1),this.updateProjection()},a.prototype.removeSelect=function(a){this.target.select.splice(a,1),this.updateProjection()},a.prototype.removeSelectPart=function(a,c){if("field"===c.def.type){if(this.selectModels.length>1){var d=b["default"].indexOf(this.selectModels,a);this.selectModels.splice(d,1)}}else{var e=b["default"].indexOf(a,c);a.splice(e,1)}this.updatePersistedParts()},a.prototype.addSelectPart=function(a,b){var d=c["default"].create({type:b});d.def.addStrategy(a,d,this),this.updatePersistedParts()},a.prototype.renderTagCondition=function(a,b){var c="",d=a.operator,e=a.value;return b>0&&(c=(a.condition||"AND")+" "),d||(d=/^\/.*\/$/.test(a.value)?"=~":"="),"=~"!==d&&"!~"!==d&&(e="'"+e.replace("\\","\\\\")+"'"),c+'"'+a.key+'" '+d+" "+e},a.prototype.getMeasurementAndPolicy=function(){var a=this.target.policy,b=this.target.measurement;return b.match("^/.*/")||(b='"'+b+'"'),a="default"!==a?'"'+this.target.policy+'".':"",a+b},a.prototype.render=function(){var a=this,c=this.target;if(c.rawQuery)return c.query;if(!c.measurement)throw{message:"Metric measurement is missing"};var d,e,f="SELECT ";for(d=0;d<this.selectModels.length;d++){var g=this.selectModels[d],h="";for(e=0;e<g.length;e++){var i=g[e];h=i.render(h)}d>0&&(f+=", "),f+=h}f+=" FROM "+this.getMeasurementAndPolicy()+" WHERE ";var j=b["default"].map(c.tags,function(b,c){return a.renderTagCondition(b,c)});f+=j.join(" "),f+=(j.length>0?" AND ":"")+"$timeFilter";var k="";for(d=0;d<this.groupByParts.length;d++){var l=this.groupByParts[d];d>0&&(k+="fill"===l.def.type?" ":", "),k+=l.render("")}return k.length&&(f+=" GROUP BY "+k),c.fill&&(f+=" fill("+c.fill+")"),c.query=f,f},a}(),a("default",d)}}});