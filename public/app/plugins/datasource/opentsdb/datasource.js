/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","app/core/utils/datemath","moment"],function(a,b,c){"use strict";function d(d,e,f,g){function h(a,c,d,e){var f=i(a,d,c,e),g=[];return b.each(a.dps,function(a,b){g.push([a,1e3*b])}),{target:f,datapoints:g}}function i(a,c,d,e){if(c.alias){var f=b.clone(e.scopedVars||{});return b.each(a.tags,function(a,b){f["tag_"+b]={value:a}}),g.replace(c.alias,f)}var h=a.metric,i=[];return b.isEmpty(a.tags)||b.each(b.pairs(a.tags),function(a){b.has(d,a[0])&&i.push(a[0]+"="+a[1])}),b.isEmpty(i)||(h+="{"+i.join(", ")+"}"),h}function j(b,c){if(!b.metric||b.hide)return null;var d={metric:g.replace(b.metric,c.scopedVars),aggregator:"avg"};if(b.aggregator&&(d.aggregator=g.replace(b.aggregator)),b.shouldComputeRate&&(d.rate=!0,d.rateOptions={counter:!!b.isCounter},b.counterMax&&b.counterMax.length&&(d.rateOptions.counterMax=parseInt(b.counterMax)),b.counterResetValue&&b.counterResetValue.length&&(d.rateOptions.resetValue=parseInt(b.counterResetValue))),!b.disableDownsampling){var e=g.replace(b.downsampleInterval||c.interval);e.match(/\.[0-9]+s/)&&(e=1e3*parseFloat(e)+"ms"),d.downsample=e+"-"+b.downsampleAggregator,b.downsampleFillPolicy&&"none"!==b.downsampleFillPolicy&&(d.downsample+="-"+b.downsampleFillPolicy)}if(d.tags=a.copy(b.tags),d.tags)for(var f in d.tags)d.tags[f]=g.replace(d.tags[f],c.scopedVars);return d}function k(a,c){var d;return b.map(a,function(a){return b.findIndex(c.targets,function(e){return e.metric===a.metric&&b.all(e.tags,function(b,e){return d=g.replace(b,c.scopedVars),a.tags[e]===d||"*"===d})})})}function l(a,b){return"now"===a?null:(a=c.parse(a,b),a.valueOf())}this.type="opentsdb",this.url=d.url,this.name=d.name,this.withCredentials=d.withCredentials,this.basicAuth=d.basicAuth,this.supportMetrics=!0,this.tagKeys={},this.query=function(a){var c=l(a.rangeRaw.from,!1),d=l(a.rangeRaw.to,!0),f=[];b.each(a.targets,function(b){b.metric&&f.push(j(b,a))});var g=b.compact(f);if(b.isEmpty(g)){var i=e.defer();return i.resolve({data:[]}),i.promise}var m={};return b.each(g,function(a){b.each(a.tags,function(a,b){m[b]=!0})}),this.performTimeSeriesQuery(g,c,d).then(function(c){var d=k(c.data,a),e=b.map(c.data,function(b,c){return c=d[c],-1===c&&(c=0),this._saveTagKeys(b),h(b,m,a.targets[c],a)}.bind(this));return{data:e}}.bind(this))},this.performTimeSeriesQuery=function(a,b,c){var d={start:b,queries:a};c&&(d.end=c);var e={method:"POST",url:this.url+"/api/query",data:d};return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth}),e.headers={"Content-Type":"application/x-www-form-urlencoded"},f.datasourceRequest(e)},this.suggestTagKeys=function(a){return e.when(this.tagKeys[a]||[])},this._saveTagKeys=function(a){var c=Object.keys(a.tags);b.each(a.aggregateTags,function(a){c.push(a)}),this.tagKeys[a.metric]=c},this._performSuggestQuery=function(a,b){return this._get("/api/suggest",{type:b,q:a,max:1e3}).then(function(a){return a.data})},this._performMetricKeyValueLookup=function(a,c){if(!a||!c)return e.when([]);var d=a+"{"+c+"=*}";return this._get("/api/search/lookup",{m:d,limit:3e3}).then(function(a){a=a.data.results;var d=[];return b.each(a,function(a){-1===d.indexOf(a.tags[c])&&d.push(a.tags[c])}),d})},this._performMetricKeyLookup=function(a){return a?this._get("/api/search/lookup",{m:a,limit:1e3}).then(function(a){a=a.data.results;var c=[];return b.each(a,function(a){b.each(a.tags,function(a,b){-1===c.indexOf(b)&&c.push(b)})}),c}):e.when([])},this._get=function(a,b){return f.datasourceRequest({method:"GET",url:this.url+a,params:b})},this.metricFindQuery=function(a){if(!a)return e.when([]);var c;try{c=g.replace(a)}catch(d){return e.reject(d)}var f=function(a){return b.map(a,function(a){return{text:a}})},h=/metrics\((.*)\)/,i=/tag_names\((.*)\)/,j=/tag_values\((.*),\s?(.*)\)/,k=/suggest_tagk\((.*)\)/,l=/suggest_tagv\((.*)\)/,m=c.match(h);if(m)return this._performSuggestQuery(m[1],"metrics").then(f);var n=c.match(i);if(n)return this._performMetricKeyLookup(n[1]).then(f);var o=c.match(j);if(o)return this._performMetricKeyValueLookup(o[1],o[2]).then(f);var p=c.match(k);if(p)return this._performSuggestQuery(p[1],"tagk").then(f);var q=c.match(l);return q?this._performSuggestQuery(q[1],"tagv").then(f):e.when([])},this.testDatasource=function(){return this._performSuggestQuery("cpu","metrics").then(function(){return{status:"success",message:"Data source is working",title:"Success"}})};var m=null;this.getAggregators=function(){return m?m:m=this._get("/api/aggregators").then(function(a){return a.data&&b.isArray(a.data)?a.data.sort():[]})}}return d.$inject=["instanceSettings","$q","backendSrv","templateSrv"],{OpenTsDatasource:d}});