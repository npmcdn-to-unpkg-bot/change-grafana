/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","moment","app/core/utils/datemath"],function(a,b,c,d){"use strict";function e(c,e,f,g){function h(a,c,d){var e=/\{\{(.+?)\}\}/g,f=c.alias||"{{metric}}_{{stat}}",h={region:g.replace(c.region,d),namespace:g.replace(c.namespace,d),metric:g.replace(c.metricName,d)},i={};b.each(b.keys(c.dimensions),function(a){var b=g.replace(a,d),e=g.replace(c.dimensions[a],d);i[b]=e}),b.extend(h,i);var j=1e3*c.period;return b.map(c.statistics,function(c){var d=[],g=null;b.chain(a.Datapoints).sortBy(function(a){return a.Timestamp}).each(function(a){var b=new Date(a.Timestamp).getTime();g&&b-g>j&&d.push([null,g+j]),g=b,d.push([a[c],b])}),h.stat=c;var i=f.replace(e,function(a,b){return h[b]?h[b]:b});return{target:i,datapoints:d}})}function i(a,c){return b.isString(a)&&(a=d.parse(a,c)),Math.round(a.valueOf()/1e3)}function j(a,c){return b.map(a,function(a,b){return{Name:g.replace(b,c),Value:g.replace(a,c)}})}this.type="cloudwatch",this.name=c.name,this.supportMetrics=!0,this.proxyUrl=c.url,this.defaultRegion=c.jsonData.defaultRegion,this.query=function(c){var d=i(c.range.from,!1),f=i(c.range.to,!0),k=[];if(c=a.copy(c),b.each(c.targets,b.bind(function(a){if(!a.hide&&a.namespace&&a.metricName&&!b.isEmpty(a.statistics)){var e={};e.region=g.replace(a.region,c.scopedVars),e.namespace=g.replace(a.namespace,c.scopedVars),e.metricName=g.replace(a.metricName,c.scopedVars),e.dimensions=j(a.dimensions,c.scopedVars),e.statistics=a.statistics;var h=f-d;e.period=parseInt(a.period,10)||("AWS/EC2"===e.namespace?300:60),h/e.period>=1440&&(e.period=60*Math.ceil(h/1440/60)),a.period=e.period,k.push(e)}},this)),b.isEmpty(k)){var l=e.defer();return l.resolve({data:[]}),l.promise}var m=b.map(k,function(a){return this.performTimeSeriesQuery(a,d,f)},this);return e.all(m).then(function(a){var d=[];return b.each(a,function(a,b){var e=h(a,c.targets[b],c.scopedVars);d=d.concat(e)}),{data:d}})},this.performTimeSeriesQuery=function(a,b,c){return this.awsRequest({region:a.region,action:"GetMetricStatistics",parameters:{namespace:a.namespace,metricName:a.metricName,dimensions:a.dimensions,statistics:a.statistics,startTime:b,endTime:c,period:a.period}})},this.getRegions=function(){return this.awsRequest({action:"__GetRegions"})},this.getNamespaces=function(){return this.awsRequest({action:"__GetNamespaces"})},this.getMetrics=function(a,b){return this.awsRequest({action:"__GetMetrics",region:b,parameters:{namespace:g.replace(a)}})},this.getDimensionKeys=function(a,b){return this.awsRequest({action:"__GetDimensions",region:b,parameters:{namespace:g.replace(a)}})},this.getDimensionValues=function(a,c,d,e,f){var h={region:g.replace(a),action:"ListMetrics",parameters:{namespace:g.replace(c),metricName:g.replace(d),dimensions:j(f,{})}};return this.awsRequest(h).then(function(a){return b.chain(a.Metrics).pluck("Dimensions").flatten().filter(function(a){return null!==a&&a.Name===e}).pluck("Value").uniq().sortBy().map(function(a){return{value:a,text:a}}).value()})},this.performEC2DescribeInstances=function(a,b,c){return this.awsRequest({region:a,action:"DescribeInstances",parameters:{filter:b,instanceIds:c}})},this.metricFindQuery=function(a){var c,d,f,h=function(a){return b.map(a,function(a){return{text:a}})},i=a.match(/^regions\(\)/);if(i)return this.getRegions();var j=a.match(/^namespaces\(\)/);if(j)return this.getNamespaces();var k=a.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(k)return this.getMetrics(k[1],k[3]);var l=a.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(l)return this.getDimensionKeys(l[1],l[3]);var m=a.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/);if(m){c=g.replace(m[1]),d=g.replace(m[2]),f=g.replace(m[3]);var n=g.replace(m[4]);return this.getDimensionValues(c,d,f,n,{})}var o=a.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(o){c=g.replace(o[1]);var p=g.replace(o[2]),q=[p];return this.performEC2DescribeInstances(c,[],q).then(function(a){var c=b.map(a.Reservations[0].Instances[0].BlockDeviceMappings,function(a){return a.Ebs.VolumeId});return h(c)})}return e.when([])},this.performDescribeAlarmsForMetric=function(a,b,c,d,e,f){return this.awsRequest({region:a,action:"DescribeAlarmsForMetric",parameters:{namespace:b,metricName:c,dimensions:d,statistic:e,period:f}})},this.performDescribeAlarmHistory=function(a,b,c,d){return this.awsRequest({region:a,action:"DescribeAlarmHistory",parameters:{alarmName:b,startDate:c,endDate:d}})},this.annotationQuery=function(a){var c=a.annotation,d=g.replace(c.region),f=g.replace(c.namespace),h=g.replace(c.metricName),k=j(c.dimensions),l=b.map(c.statistics,function(a){return g.replace(a)}),m=c.period||"300";if(m=parseInt(m,10),!d||!f||!h||b.isEmpty(l))return e.when([]);var n=e.defer(),o=this,p=b.map(l,function(a){return o.performDescribeAlarmsForMetric(d,f,h,k,a,m)});return e.all(p).then(function(e){var f=[],g=i(a.range.from,!1),h=i(a.range.to,!0);b.chain(e).pluck("MetricAlarms").flatten().each(function(a){return a?void o.performDescribeAlarmHistory(d,a.AlarmName,g,h).then(function(a){b.each(a.AlarmHistoryItems,function(a){var b={annotation:c,time:Date.parse(a.Timestamp),title:a.AlarmName,tags:[a.HistoryItemType],text:a.HistorySummary};f.push(b)}),n.resolve(f)}):void n.resolve(f)})}),n.promise},this.testDatasource=function(){var a=this.defaultRegion,b="AWS/Billing",c="EstimatedCharges",d={};return this.getDimensionValues(a,b,c,"ServiceName",d).then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},this.awsRequest=function(a){var b={method:"POST",url:this.proxyUrl,data:a};return f.datasourceRequest(b).then(function(a){return a.data})},this.getDefaultRegion=function(){return this.defaultRegion}}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],{CloudWatchDatasource:e}});