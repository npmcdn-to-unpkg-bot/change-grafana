/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","app/core/config"],function(a,b,c){"use strict";var d=a.module("grafana.controllers"),e=[];d.directive("datasourceHttpSettings",function(){return{scope:{current:"="},templateUrl:"public/app/features/datasources/partials/http_settings.html"}}),d.controller("DataSourceEditCtrl",["$scope","$q","backendSrv","$routeParams","$location","datasourceSrv",function(b,d,f,g,h,i){var j={name:"",type:"graphite",url:"",access:"proxy",jsonData:{}};b.init=function(){b.isNew=!0,b.datasources=[],b.loadDatasourceTypes().then(function(){g.id?b.getDatasourceById(g.id):(b.current=a.copy(j),b.typeChanged())})},b.loadDatasourceTypes=function(){return e.length>0?(b.types=e,d.when(null)):f.get("/api/datasources/plugins").then(function(a){e=a,b.types=a})},b.getDatasourceById=function(a){f.get("/api/datasources/"+a).then(function(a){return b.isNew=!1,b.current=a,b.typeChanged()})},b.typeChanged=function(){b.datasourceMeta=b.types[b.current.type]},b.updateFrontendSettings=function(){return f.get("/api/frontend/settings").then(function(a){c.datasources=a.datasources,c.defaultDatasource=a.defaultDatasource,i.init()})},b.testDatasource=function(){b.testing={done:!1},i.get(b.current.name).then(function(a){return a.testDatasource?a.testDatasource().then(function(a){b.testing.message=a.message,b.testing.status=a.status,b.testing.title=a.title},function(a){a.statusText?(b.testing.message=a.statusText,b.testing.title="HTTP Error"):(b.testing.message=a.message,b.testing.title="Unknown error")}):(b.testing.message="Data source does not support test connection feature.",b.testing.status="warning",void(b.testing.title="Unknown"))})["finally"](function(){b.testing.done=!0})},b.saveChanges=function(a){return b.editForm.$valid?b.current.id?f.put("/api/datasources/"+b.current.id,b.current).then(function(){b.updateFrontendSettings().then(function(){a&&b.testDatasource()})}):f.post("/api/datasources",b.current).then(function(a){b.updateFrontendSettings(),h.path("datasources/edit/"+a.id)}):void 0},b.init()}])});