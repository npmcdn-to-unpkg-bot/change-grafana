/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","jquery"],function(a,b,c){"use strict";var d=a.module("grafana.services");d.factory("dashboardViewStateSrv",["$location","$timeout",function(a,d){function e(a){var b=this;b.state={},b.panelScopes=[],b.$scope=a,b.dashboard=a.dashboard,a.exitFullscreen=function(){b.state.fullscreen&&b.update({fullscreen:!1})},a.onAppEvent("$routeUpdate",function(){var a=b.getQueryStringState();b.needsSync(a)&&b.update(a,!0)}),a.onAppEvent("panel-change-view",function(a,c){b.update(c)}),a.onAppEvent("panel-instantiated",function(a,c){b.registerPanel(c.scope)}),this.update(this.getQueryStringState(),!0),this.expandRowForPanel()}return e.prototype.expandRowForPanel=function(){if(this.state.panelId){var a=this.$scope.dashboard.getPanelInfoById(this.state.panelId);a&&(a.row.collapse=!1)}},e.prototype.needsSync=function(a){return b.isEqual(this.state,a)===!1},e.prototype.getQueryStringState=function(){var b=a.search();return b.panelId=parseInt(b.panelId)||null,b.fullscreen=b.fullscreen?!0:null,b.edit="true"===b.edit||b.edit===!0||null,b.editview=b.editview||null,b},e.prototype.serializeToUrl=function(){var a=b.clone(this.state);return a.fullscreen=this.state.fullscreen?!0:null,a.edit=this.state.edit?!0:null,a},e.prototype.update=function(c,d){b.extend(this.state,c),this.dashboard.meta.fullscreen=this.state.fullscreen,this.state.fullscreen||(this.state.panelId=null,this.state.fullscreen=null,this.state.edit=null),d||a.search(this.serializeToUrl()),this.syncState()},e.prototype.syncState=function(){if(0!==this.panelScopes.length){if(this.dashboard.meta.fullscreen){this.fullscreenPanel&&this.leaveFullscreen(!1);var a=this.getPanelScope(this.state.panelId);if(!a)return;return a.ctrl.editModeInitiated||a.ctrl.initEditMode(),void this.enterFullscreen(a)}this.fullscreenPanel&&this.leaveFullscreen(!0)}},e.prototype.getPanelScope=function(a){return b.find(this.panelScopes,function(b){return b.ctrl.panel.id===a})},e.prototype.leaveFullscreen=function(a){var b=this,c=b.fullscreenPanel.ctrl;return c.editMode=!1,c.fullscreen=!1,delete c.height,this.$scope.appEvent("panel-fullscreen-exit",{panelId:c.panel.id}),a?void d(function(){b.oldTimeRange!==c.range?b.$scope.broadcastRefresh():b.fullscreenPanel.$broadcast("render"),delete b.fullscreenPanel}):!1},e.prototype.enterFullscreen=function(a){var b=c(window).height(),e=Math.floor(.3*b),f=Math.floor(.7*b),g=a.ctrl;g.editMode=this.state.edit&&this.$scope.dashboardMeta.canEdit,g.height=g.editMode?e:f,g.fullscreen=!0,this.oldTimeRange=g.range,this.fullscreenPanel=a,c(window).scrollTop(0),this.$scope.appEvent("panel-fullscreen-enter",{panelId:g.panel.id}),d(function(){a.$broadcast("render")})},e.prototype.registerPanel=function(a){var c=this;c.panelScopes.push(a),c.state.panelId===a.ctrl.panel.id&&(c.state.edit?a.ctrl.editPanel():a.ctrl.viewPanel()),a.$on("$destroy",function(){c.panelScopes=b.without(c.panelScopes,a)})},{create:function(a){return new e(a)}}}])});