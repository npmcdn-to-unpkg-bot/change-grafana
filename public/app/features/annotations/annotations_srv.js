/*! grafana - v3.0.0-pre1 - 2016-02-22
 * Copyright (c) 2016 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./editor_ctrl"],function(a,b){"use strict";var c=a.module("grafana.services");c.service("annotationsSrv",["$rootScope","$q","datasourceSrv","alertSrv","timeSrv",function(c,d,e,f,g){function h(a){console.log("Annotation error: ",a);var b=a.message||"Annotation query failed";f.set("Annotations error",b,"error")}var i,j=[],k=this;this.init=function(){c.onAppEvent("refresh",this.clearCache,c),c.onAppEvent("dashboard-loaded",this.clearCache,c)},this.clearCache=function(){i=null,j=[]},this.getAnnotations=function(c){if(0===c.annotations.list.length)return d.when(null);if(i)return i;k.dashboard=c;var f=b.where(c.annotations.list,{enable:!0}),l=g.timeRange(),m=g.timeRange(!1),n=b.map(f,function(b){return b.snapshotData?void k.receiveAnnotationResults(b.snapshotData):e.get(b.datasource).then(function(d){var e={range:l,rangeRaw:m,annotation:b};return d.annotationQuery(e).then(k.receiveAnnotationResults).then(function(d){c.snapshot&&(b.snapshotData=a.copy(d))}).then(null,h)},this)});return i=d.all(n).then(function(){return j})},this.receiveAnnotationResults=function(a){for(var b=0;b<a.length;b++)k.addAnnotation(a[b]);return a},this.addAnnotation=function(a){j.push({annotation:a.annotation,min:a.time,max:a.time,eventType:a.annotation.name,title:a.title,tags:a.tags,text:a.text,score:1})},this.init()}])});